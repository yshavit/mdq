name: Publish release
on:
  workflow_dispatch:
    inputs:
      version:
        description: "The version to release, e.g. \"0.1.2\""
        type: string
        required: true

env:
  BRANCH_NAME: "pending-releases/${{ inputs.version }}"

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Get PR Info
        id: pr-info
        run: |
          set -euo pipefail
          pr_json="$(gh pr view -R "$REPO_NAME" "$BRANCH_NAME" --json mergeStateStatus,body)"
          <<<"$pr_json" | jq .
          echo "json=$pr_json" >> "$GITHUB_OUTPUT"
        env:
          REPO_NAME: ${{ github.repository }}
      - name: Validate PR status
        run: |
          set -euo pipefail
          merge_status="$(<<<"$PR_JSON" jq -r .mergeStateStatus)"
          if [[ "$merge_status" != CLEAN ]]; then
            echo "::error title=invalid branch state::require CLEAN, saw $merge_status"
            exit 1
          fi
        env:
          PR_JSON: ${{ steps.pr-info.outputs.json }}
